name: CI


on: [push, pull_request]


jobs:
  ##############################################################################
  # msvc
  ##############################################################################
  msvc:
    name: MSVC

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: "Setup Conda"
        uses: conda-incubator/setup-miniconda@v2.2.0
        with:
          miniconda-version: "latest"
          channels: conda-forge

      - name: "Install dependencies"
        run: |
          conda install --yes -c conda-forge mpfr
          conda install --yes -c conda-forge pthreads-win32
          conda info
          conda list

      - name: "Setup MSVC"
        uses: ilammy/msvc-dev-cmd@v1.12.1
        with:
          arch: x86_64

      - name: "Configure"
        run: |
          mkdir build
          cd build
          set "LIB=C:\Miniconda3\Library\lib;%LIB%"
          set "CPATH=C:\Miniconda3\Library\include;%CPATH%"
          cmake -G "Ninja" -DCMAKE_C_FLAGS="/wd4018 /wd4146 /wd4244 /wd4267 /wd4305 /wd4996 /Zi /EHsc" -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release ..

      - name: "Build"
        run: |
          cd build
          cmake --build . -- -j4

      - name: "Test"
        run: |
          cd build
          cdb -c ".logopen logfile; .logg; g" bin\src-fmpz_poly_factor-test-t-test.exe
          type logfile
